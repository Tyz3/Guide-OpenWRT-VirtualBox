# О репозитории
Здесь представлено руководство по настройке роутера OpenWRT в виде виртуальной машины VirtualBox. Выполняется подключение виртуальных машин к сети роутера. Дополнительно настраивается OpenVPN на роутере.

# Предварительные требования
1. Установлен VirtualBox

# Прошивка OpenWRT
1. На [сайте](https://downloads.openwrt.org/releases/) с прошивками скачиваем последнюю версию (на момент написания руководства - [22.03.5 generic-ext4-combined.img.gz](https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/)).

Прямая ссылка: [generic-ext4-combined.img.gz](https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/openwrt-22.03.5-x86-64-generic-ext4-combined.img.gz)
2. Распакованный образ копируем в корневой каталог установки VirtualBox и конвертируем его в формат VDI.
```
./VBoxManage.exe convertfromraw --format VDI openwrt-22.03.5-x86-64-generic-ext4-combined.img openwrt-22.03.5.vdi
```
> Файл .img больше не нужен, а .vdi можно скопировать в удобное место для дальнейшего использования в VirtualBox.

# Создание ВМ
1. При создании ВМ в **Имя и тип ОС** не указываем образ. В меню **Жёсткий диск** нужно включить **Использовать существующий виртуальный жёсткий диск**. Добавляем наш .vdi и выбираем его.
![изображение](https://github.com/Tyz3/Guide-OpenWRT-VirtualBox/assets/21179689/f8203a97-7d38-4d38-bfcb-d418e5ab4b80)

Настройки оборудования можно поставить следующие: основная память(ОЗУ) - **256МБ**, процессоры - 1.
Нажимаете **Готово**.

2. Переходите к настройкам ВМ - **Сеть**. Добавляете второй адаптер, указываете следующие настройки:
```
Адаптер 1
Тип: Внутренняя сеть
Имя: intnet-openwrt

Адаптер 2
Тип: Сетевой мост
Имя: ваша сетевая карта
```
> Адаптер под номером 2 считается **WAN**, а 1 - **LAN**.

3. Настройка выполнена, теперь при создании других ВМ, например, с Windows 10, в настройках сети адаптера указываете внутренняя сеть с именем **intnet-openwrt**.

Теперь весь трафик, подключенный к сети **intnet-openwrt**, будет идти через роутер. Дополнительных настроек делать не нужно.

# Подключение роутера к роутеру

Если стоит задача создать связку из нескольких VPN, например, Double VPN, или добавить связку с TOR (VPN-TOR-VPN), или к NYM - достаточно создать несколько роутеров и подключить их друг к другу, предварительно выполнив подключение к VPN/TOR/NYM на каждом.

1. Рассмотрим пример с двойным VPN, тогда настройка адаптеров **Сети** роутеров будет следующая:
```
R1 (выход в интернет)
Адаптер 1
Тип: Внутренняя сеть
Имя: intnet-openwrt-1

Адаптер 2
Тип: Сетевой мост

R2 (подключен к R1)
Адаптер 1
Тип: Внутренняя сеть
Имя: intnet-openwrt-2

Адаптер 2
Тип: Внутренняя сеть
Имя: intnet-openwrt-1
```
> Получается, что WAN для R2 это LAN для R1.

**Важная помарка**: у R2 должна быть перенастроена сеть LAN с дефолтного 192.168.1.1/24 на 192.168.2.1/24, чтобы не было конфликта с R1.

2. Изменение настроек сети LAN на R2.

![изображение](https://github.com/Tyz3/Guide-OpenWRT-VirtualBox/assets/21179689/7a1d1a36-7203-4753-bcb4-7f752b3df5e3)

![изображение](https://github.com/Tyz3/Guide-OpenWRT-VirtualBox/assets/21179689/2d18bd47-ec6d-4408-a31d-6207acee780c)

Сохраняем, применяем и ждём, пока роутер применит настройки.

3. Если нужно отключить IPv6, делаем следующее.

![изображение](https://github.com/Tyz3/Guide-OpenWRT-VirtualBox/assets/21179689/8d6a5a46-4e10-44a3-bd4a-0d5a05b86cdc)

# Установка OpenVPN на роутер (без утечек)

1. 

